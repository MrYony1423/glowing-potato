<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MyVideoApp - TikTok Like</title>
<style>
  body, html {
    margin: 0; padding: 0; background: black; color: white; font-family: Arial, sans-serif;
    display: flex; flex-direction: column; align-items: center;
  }
  #auth, #upload-section, #video-feed { width: 90vw; max-width: 600px; }
  input, button, textarea {
    padding: 10px; margin: 8px 0; font-size: 1rem; border-radius: 5px; border: none;
  }
  button {
    background-color: #1da1f2; color: white; cursor: pointer;
  }
  button:disabled {
    background-color: gray; cursor: not-allowed;
  }
  video {
    width: 100%; max-height: 400px; margin: 10px 0; border-radius: 12px;
  }
  .video-container {
    border-bottom: 1px solid #333; padding-bottom: 20px; margin-bottom: 20px;
  }
  .actions {
    display: flex; gap: 15px; margin-top: 5px;
  }
  .like-btn, .comment-btn {
    background: none; border: none; color: #ff4757; font-size: 1.3rem; cursor: pointer;
  }
  .comments {
    margin-top: 10px; font-size: 0.9rem; color: #aaa;
  }
  #comment-input {
    width: 100%; margin-top: 10px;
  }
</style>
</head>
<body>

<h1>ברוכים הבאים ל-MyVideoApp</h1>

<div id="auth">
  <input id="email" type="email" placeholder="אימייל" />
  <input id="password" type="password" placeholder="סיסמה" />
  <button id="signupBtn">הרשמה</button>
  <button id="loginBtn">התחברות</button>
</div>

<div id="upload-section" style="display:none;">
  <input type="file" id="videoFile" accept="video/*" />
  <textarea id="videoDesc" placeholder="תיאור הסרטון (אופציונלי)"></textarea>
  <button id="uploadBtn" disabled>העלה סרטון</button>
  <button id="logoutBtn" style="background:#f44336;">התנתק</button>
</div>

<div id="video-feed"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  // הכנס כאן את פרטי ה-Firebase שלך:
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  // אתחל Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // אלמנטים
  const authDiv = document.getElementById('auth');
  const uploadSection = document.getElementById('upload-section');
  const videoFeed = document.getElementById('video-feed');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const signupBtn = document.getElementById('signupBtn');
  const loginBtn = document.getElementById('loginBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const videoFileInput = document.getElementById('videoFile');
  const videoDescInput = document.getElementById('videoDesc');
  const logoutBtn = document.getElementById('logoutBtn');

  // אפשר להעלות רק כשיש קובץ
  videoFileInput.addEventListener('change', () => {
    uploadBtn.disabled = !videoFileInput.files.length;
  });

  // הרשמה
  signupBtn.onclick = () => {
    const email = emailInput.value;
    const pass = passwordInput.value;
    if (!email || !pass) return alert('מלא אימייל וסיסמה');
    auth.createUserWithEmailAndPassword(email, pass)
      .then(() => alert('נרשמת בהצלחה!'))
      .catch(e => alert(e.message));
  };

  // התחברות
  loginBtn.onclick = () => {
    const email = emailInput.value;
    const pass = passwordInput.value;
    if (!email || !pass) return alert('מלא אימייל וסיסמה');
    auth.signInWithEmailAndPassword(email, pass)
      .then(() => {
        alert('התחברת!');
      })
      .catch(e => alert(e.message));
  };

  // התנתקות
  logoutBtn.onclick = () => {
    auth.signOut().then(() => {
      alert('התנתקת');
    });
  };

  // העלאת סרטון
  uploadBtn.onclick = async () => {
    const file = videoFileInput.files[0];
    if (!file) return alert('בחר סרטון');

    uploadBtn.disabled = true;
    uploadBtn.textContent = 'מעלה...';

    try {
      const user = auth.currentUser;
      if (!user) throw new Error('לא מחובר');

      // יצירת שם ייחודי לקובץ
      const fileName = user.uid + '_' + Date.now() + '_' + file.name;
      const storageRef = storage.ref('videos/' + fileName);

      // העלאת הקובץ
      await storageRef.put(file);

      // קבלת URL לצפייה
      const url = await storageRef.getDownloadURL();

      // שמירת מידע במסד
      await db.collection('videos').add({
        url,
        description: videoDescInput.value || '',
        userId: user.uid,
        userEmail: user.email,
        likes: 0,
        comments: [],
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      alert('סרטון הועלה בהצלחה!');
      videoFileInput.value = '';
      videoDescInput.value = '';
      uploadBtn.disabled = true;
      loadVideos();

    } catch (e) {
      alert(e.message);
    } finally {
      uploadBtn.textContent = 'העלה סרטון';
      uploadBtn.disabled = false;
    }
  };

  // טעינת סרטונים
  function loadVideos() {
    videoFeed.innerHTML = '';
    db.collection('videos')
      .orderBy('createdAt', 'desc')
      .onSnapshot(snapshot => {
        videoFeed.innerHTML = '';
        snapshot.forEach(doc => {
          const data = doc.data();

          const container = document.createElement('div');
          container.className = 'video-container';

          const video = document.createElement('video');
          video.src = data.url;
          video.controls = true;

          const desc = document.createElement('p');
          desc.textContent = data.description || '(ללא תיאור)';

          // כפתור לייק
          const likeBtn = document.createElement('button');
          likeBtn.textContent = `❤️ ${data.likes}`;
          likeBtn.className = 'like-btn';

          likeBtn.onclick = () => {
            const increment = firebase.firestore.FieldValue.increment(1);
            db.collection('videos').doc(doc.id).update({ likes: increment });
          };

          // אזור תגובות
          const commentsDiv = document.createElement('div');
          commentsDiv.className = 'comments';

          // הצגת תגובות קיימות
          if (data.comments && data.comments.length) {
            data.comments.forEach(c => {
              const cP = document.createElement('p');
              cP.textContent = `${c.userEmail}: ${c.text}`;
              commentsDiv.appendChild(cP);
            });
          }

          // הוספת תגובה חדשה
          const commentInput = document.createElement('input');
          commentInput.placeholder = 'כתוב תגובה...';
          commentInput.style.width = '80%';
          const commentBtn = document.createElement('button');
          commentBtn.textContent = 'שלח';
          commentBtn.className = 'comment-btn';

          commentBtn.onclick = () => {
            const user = auth.currentUser;
            if (!user) return alert('אתה חייב להתחבר כדי להגיב');

            const text = commentInput.value.trim();
            if (!text) return alert('כתוב תגובה');

            db.collection('videos').doc(doc.id).update({
              comments: firebase.firestore.FieldValue.arrayUnion({
                userEmail: user.email,
                text
              })
            });
            commentInput.value = '';
          };

          container.appendChild(video);
          container.appendChild(desc);
          container.appendChild(likeBtn);
          container.appendChild(commentsDiv);
          container.appendChild(commentInput);
          container.appendChild(commentBtn);

          videoFeed.appendChild(container);
        });
      });
  }

  // בדיקה אם המשתמש מחובר
  auth.onAuthStateChanged(user => {
    if (user) {
      authDiv.style.display = 'none';
      uploadSection.style.display = 'block';
      loadVideos();
    } else {
      authDiv.style.display = 'block';
      uploadSection.style.display = 'none';
      videoFeed.innerHTML = '';
    }
  });
</script>

</body>
</html>
